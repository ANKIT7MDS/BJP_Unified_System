<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin • Visitors & Events</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --brand:#ff6a00; --brand-600:#ff7f26; --brand-700:#ff9933; --brand-800:#e25800; --text:#202124; --muted:#6b7280; --surface:#ffffff; --bg:#fff8f1; --line:#f1f5f9; --chip:#fff2e6; }
    *{box-sizing:border-box} body{font-family:'Noto Sans Devanagari',system-ui,-apple-system,Arial,sans-serif;background:var(--bg);margin:0;color:var(--text)}
    .wrap{max-width:1400px;margin:24px auto;background:var(--surface);padding:18px 18px 28px;border-radius:16px;box-shadow:0 8px 24px rgba(255,106,0,.12)}
    .brandbar{display:flex;align-items:center;gap:10px;margin-bottom:12px} .branddot{height:14px;width:14px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 4px #ffe5d1}
    h1{margin:0 0 4px;font-weight:800} .subtitle{color:var(--muted);font-size:14px;margin-bottom:12px}
    .filters{display:grid;grid-template-columns:repeat(auto-fit, minmax(130px, 1fr));gap:10px} .filters .cell{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:#555;font-weight:bold;} input,select,button{padding:10px;border:1px solid var(--line);border-radius:10px;font-size:14px;background:#fff}
    button.btn{background:var(--brand);color:#fff;border:none;cursor:pointer;transition:.15s;box-shadow:0 4px 10px rgba(255,106,0,.18)} button.btn:hover{background:var(--brand-800)} button.btn.ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)} button.btn.danger{background:#dc2626}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0} .chips{display:flex;gap:8px;flex-wrap:wrap} .chip{padding:6px 10px;border:1px dashed var(--brand-700);background:var(--chip);border-radius:999px;cursor:pointer;font-size:12px} .chip.active{background:var(--brand);color:#fff;border-style:solid}
    table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid #f0f0f0;text-align:left;font-size:14px} th{background:#fff6ee;position:sticky;top:0;z-index:1}
    .foot{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:14px 0} .empty{padding:16px;color:#777} img.preview{height:44px;width:44px;object-fit:cover;border-radius:8px;cursor:pointer;border:1px solid #eee}
    .cards{display:grid;grid-template-columns:repeat(auto-fit, minmax(400px, 1fr));gap:14px;margin-top:16px} .card{border:1px solid #ffe1c4;border-radius:14px;padding:12px;background:#fffefb} .card h3{margin:0 0 8px} .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px} .notice{background:#fff1e6;border:1px solid #ffd2ad;padding:10px;border-radius:10px;color:#7a3e00} .table-wrap{border:1px solid #eee;border-radius:12px;overflow:auto;margin-top:12px;max-height:60vh;background:#fff} .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#fff;border:1px solid var(--brand);color:var(--brand)} .metric{display:inline-flex;align-items:baseline;gap:6px;background:#fff;border:1px solid #ffe1c4;border-radius:12px;padding:8px 10px;margin:6px 6px 0 0} .metric b{font-size:18px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="brandbar"><div class="branddot"></div><h1>एडमिन पैनल (Visitor)</h1></div>
    <div class="subtitle">डेटा अब 'mandaleventall' से कनेक्टेड है। इवेंट कलेक्शन: 'visitor_events_list'</div>
    <div class="chips" style="margin-bottom:8px">
      <div class="chip active" data-type="">सभी विज़िटर</div>
      <div class="chip" data-type="office">भाजपा कार्यालय (डेली)</div>
      <div class="chip" data-type="event">इवेंट विज़िटर</div>
    </div>
    <div class="filters" style="margin-bottom:12px">
      <div class="cell"><label>From</label><input type="date" id="fromDate"></div>
      <div class="cell"><label>To</label><input type="date" id="toDate"></div>
      <div class="cell"><label>District</label><select id="distSelect"><option value="">— सभी —</option></select></div>
      <div class="cell"><label>Mandal</label><select id="mandalSelect"><option value="">— सभी —</option></select></div>
      <div class="cell"><label>कारण</label><select id="reasonSelect"><option value="">— सभी —</option></select></div>
      <div class="cell"><label>इवेंट</label><select id="eventSelect"><option value="">— सभी —</option></select></div>
      <div class="cell"><label>खोजें</label><input id="searchInput" placeholder="नाम/मोबाइल/पता"></div>
    </div>
    <div class="toolbar"><button id="clearBtn" class="btn ghost">♻️ Clear Filters</button><span id="activeTypeBadge" class="badge">व्यू: सभी</span></div>
    <div class="card">
      <div class="toolbar" style="justify-content:space-between">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap"><input id="eventNameInput" placeholder="नया इवेंट नाम" style="min-width:260px"><button id="addEventBtn" class="btn">इवेंट जोड़ें</button></div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap"><label>Active:</label><select id="eventActiveSelect" style="min-width:260px"></select><button id="setActiveBtn" class="btn">Active करें</button><button id="endEventBtn" class="btn danger">Deactivate</button></div>
      </div>
    </div>
    <div class="toolbar" id="metricsBar"><div class="metric">कुल विज़िटर: <b id="totalCounter">0</b></div><div class="metric">इवेंट-वाइज: <b id="eventWiseTotal">0</b></div></div>
    <div class="table-wrap">
      <table id="dataTable">
        <thead><tr><th>समय</th><th>नाम</th><th>मोबाइल</th><th>जिला</th><th>मंडल</th><th>पद</th><th>कारण</th><th>पता</th><th>फोटो</th></tr></thead>
        <tbody></tbody>
      </table>
      <div id="emptyState" class="empty" style="display:none">कोई डेटा नहीं मिला…</div>
    </div>
    <div class="foot">
      <div style="display:flex;gap:8px;"><button id="prevPage" class="btn">◀</button><span id="pageInfo">Page 1</span><button id="nextPage" class="btn">▶</button></div>
      <div style="display:flex;gap:8px;"><button id="loadAllBtn" class="btn ghost">⚡ सभी पुराने रिकॉर्ड</button><button id="exportBtn" class="btn">Export CSV</button></div>
    </div>
  </div>
<script>
  // Unified Config (Mandal Project)
  const firebaseConfig = { apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0", authDomain: "mandaleventall.firebaseapp.com", projectId: "mandaleventall", storageBucket: "mandaleventall.firebasestorage.app", messagingSenderId: "900190130114", appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b", measurementId: "G-2BBZZNRS88" };
  if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const $ = (id)=>document.getElementById(id);
  const OFFICE_REASONS = ["कार्यालय पर बैठक", "जिला अध्यक्ष से भेंट", "ट्रांसफर / शासकीय कार्य / शिकायत", "कार्यालय पर सामान्य उपस्थिति", "अन्य कोई कार्य"];
  const state = { all: [], lastDoc: null, page: 1, pageSize: 25, filtered: [], events: [], historicalEventNames: new Set(), viewType: "" };

  function tsToLocal(ts){ try{ const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null); return d ? d.toLocaleString('en-IN',{hour12:false}) : ''; }catch(_){ return ''; } }
  function fillSelect(sel, items, placeholder){ sel.innerHTML = ''; const opt0 = document.createElement('option'); opt0.value = ''; opt0.textContent = placeholder || '— चुनें —'; sel.appendChild(opt0); items.forEach(v=>{ const op = document.createElement('option'); op.value = v; op.textContent = v; sel.appendChild(op); }); }
  function computeEventName(row){ const isOffice = OFFICE_REASONS.includes(row.reason||""); return row.eventName || row.eventId || (!isOffice ? (row.reason||"") : ""); }
  function isEventRow(row){ return !!computeEventName(row); }
  function deriveHistoricalEvents(){ const set = new Set(); state.all.forEach(r=>{ const name = computeEventName(r); if (name) set.add(name); }); state.historicalEventNames = set; }
  
  function populateDynamicFilters(){
    const mandals = new Set(); state.all.forEach(r => { if(r.mandal && r.mandal !== "Unknown") mandals.add(r.mandal); }); fillSelect($('mandalSelect'), Array.from(mandals).sort(), '— सभी —');
    const dists = new Set(); state.all.forEach(r => { if(r.district) dists.add(r.district); }); fillSelect($('distSelect'), Array.from(dists).sort(), '— सभी —');
    const names = new Set([...state.historicalEventNames]); state.events.forEach(e => e.name && names.add(e.name)); fillSelect($('eventSelect'), Array.from(names).sort(), '— सभी —');
  }
  function populateActiveDropdown(){
    const select = $('eventActiveSelect'); select.innerHTML = ''; const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='— इवेंट चुनें —'; select.appendChild(opt0);
    const existingNames = new Set();
    state.events.forEach(ev=>{ existingNames.add(ev.name); const op = document.createElement('option'); op.value = ev.id; op.textContent = ev.name + (ev.active ? ' (Active)' : ''); select.appendChild(op); });
  }
  function applyFilter(){
    const q = ($('searchInput').value || '').toLowerCase().trim(); const fr = $('fromDate').value; const to = $('toDate').value;
    const rs = $('reasonSelect').value; const md = $('mandalSelect').value; const ds = $('distSelect').value; const ev = $('eventSelect').value;
    let rows = [...state.all];
    if (state.viewType === 'office') rows = rows.filter(r => !isEventRow(r)); else if (state.viewType === 'event') rows = rows.filter(r => isEventRow(r));
    if (fr) { const s = new Date(fr + 'T00:00:00'); rows = rows.filter(r => r.timestamp?.toDate ? r.timestamp.toDate() >= s : true); }
    if (to) { const e = new Date(to + 'T23:59:59'); rows = rows.filter(r => r.timestamp?.toDate ? r.timestamp.toDate() <= e : true); }
    if (rs) rows = rows.filter(r => (r.reason || '') === rs); if (md) rows = rows.filter(r => (r.mandal || '') === md); if (ds) rows = rows.filter(r => (r.district || '') === ds); if (ev) rows = rows.filter(r => computeEventName(r) === ev);
    if (q) rows = rows.filter(r => `${r.name} ${r.mobile} ${r.address} ${r.designation}`.toLowerCase().includes(q));
    state.filtered = rows.sort((a,b)=> (b.timestamp?.toMillis?.()||0) - (a.timestamp?.toMillis?.()||0)); renderAll();
  }
  function renderAll(){ state.page = 1; renderTable(); $('totalCounter').textContent = state.filtered.length; let evCount = 0; state.filtered.forEach(r => { if (isEventRow(r)) evCount++; }); $('eventWiseTotal').textContent = evCount; }
  function renderTable(){
    const tbody = $('dataTable').querySelector('tbody'); tbody.innerHTML = '';
    const slice = state.filtered.slice((state.page - 1) * state.pageSize, state.page * state.pageSize);
    if (!slice.length) $('emptyState').style.display = 'block'; else $('emptyState').style.display = 'none';
    slice.forEach(row=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${tsToLocal(row.timestamp)}</td><td>${row.name||''}</td><td>${row.mobile||''}</td><td>${row.district||''}</td><td>${row.mandal||''}</td><td>${row.designation||''}</td><td>${computeEventName(row)||row.reason||'—'}</td><td>${row.address||''}</td><td>${row.selfie ? `<a href="${row.selfie}" target="_blank"><img class="preview" src="${row.selfie}"></a>` : ''}</td>`;
      tbody.appendChild(tr);
    });
    $('pageInfo').textContent = `Page ${state.page}`;
  }
  // Data Loaders
  db.collection("visitors").orderBy("timestamp","desc").limit(1000).onSnapshot((snap) => {
    const latest = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    const map = new Map(state.all.map(r=>[r.id,r])); latest.forEach(r=>map.set(r.id,r));
    state.all = [...map.values()].sort((a,b)=> (b.timestamp?.toMillis?.()||0) - (a.timestamp?.toMillis?.()||0));
    if (latest.length) state.lastDoc = snap.docs[snap.docs.length-1];
    deriveHistoricalEvents(); populateDynamicFilters(); populateActiveDropdown(); applyFilter();
  });
  // Events Collection (UPDATED NAME)
  db.collection('visitor_events_list').orderBy('createdAt','desc').onSnapshot(s=>{
    state.events = s.docs.map(d=>({ id: d.id, ...d.data() })); populateDynamicFilters(); populateActiveDropdown();
  });
  // Actions
  async function setOnlyThisActiveOrCreate(value){
    if (value.startsWith('name:')){ const name = value.slice(5); const ref = await db.collection('visitor_events_list').add({ name, active:false, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); await setOnlyThisActive(ref.id); return; }
    await setOnlyThisActive(value);
  }
  async function setOnlyThisActive(docId){ const batch = db.batch(); (await db.collection('visitor_events_list').get()).forEach(d => batch.update(d.ref, { active: d.id === docId })); await batch.commit(); }
  async function clearActive(){ const batch = db.batch(); (await db.collection('visitor_events_list').where('active','==',true).get()).forEach(d => batch.update(d.ref, { active:false })); await batch.commit(); }
  $('addEventBtn')?.addEventListener('click', async ()=>{ const name = ($('eventNameInput').value || '').trim(); if (!name) return; await db.collection('visitor_events_list').add({ name, active:false, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); $('eventNameInput').value=''; });
  $('setActiveBtn')?.addEventListener('click', async ()=>{ const value = $('eventActiveSelect').value; if(value) await setOnlyThisActiveOrCreate(value); });
  $('endEventBtn')?.addEventListener('click', clearActive);
  $('loadAllBtn').addEventListener('click', async ()=>{ /* Load all logic similar to original but with unified config */ Swal.fire('Load All', 'Fetching older records...', 'info'); });
  $('exportBtn').addEventListener('click', ()=>{ /* Export CSV logic */ });
  // Init
  fillSelect($('reasonSelect'), OFFICE_REASONS, '— सभी —');
  ['fromDate','toDate','reasonSelect','mandalSelect','distSelect','eventSelect','searchInput'].forEach(id=>{ const el=$(id); el && el.addEventListener(el.tagName==='INPUT'?'input':'change', applyFilter); });
  document.querySelectorAll('.chip').forEach(el=>el.addEventListener('click',()=>{ document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); state.viewType = el.dataset.type || ''; applyFilter(); }));
  $('clearBtn').addEventListener('click', ()=>{ $('fromDate').value=''; $('toDate').value=''; $('searchInput').value=''; document.querySelectorAll('select').forEach(s=>s.value=''); document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); document.querySelector('[data-type=""]').classList.add('active'); state.viewType=''; applyFilter(); });
</script>
</body>
</html>
