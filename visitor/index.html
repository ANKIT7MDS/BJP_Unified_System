<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>आगंतुक पंजीयन • BJP Office</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: linear-gradient(135deg, #ff6a00, #ffa41b); font-family: 'Noto Sans Devanagari', sans-serif; display: flex; justify-content: center; padding: 20px 0; }
    .container { background: #fff8ef; width: 100%; max-width: 600px; border-radius: 12px; padding: 30px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
    h2 { text-align: center; color: #ff6a00; margin-bottom: 20px; }
    label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; color: #333; }
    input, select { width: 100%; padding: 12px; border: 2px solid #ffccbc; border-radius: 8px; font-size: 16px; outline: none; background: #fff; }
    input:focus, select:focus { border-color: #ff6a00; box-shadow: 0 0 5px rgba(255,106,0,0.3); }
    button { width: 100%; padding: 14px; background: #ff6a00; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 25px; transition: background 0.3s; }
    button:hover { background: #e65100; }
    #camera-area { margin-top: 20px; text-align: center; display: none; }
    video, canvas { width: 100%; max-width: 300px; border-radius: 8px; border: 2px solid #ff6a00; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>
  <div class="container">
    <h2>स्वागतम! भारतीय जनता पार्टी</h2>
    <form id="visitorForm">
      <label>मोबाइल नंबर</label>
      <input type="tel" id="mobile" maxlength="10" placeholder="अपना 10 अंकों का मोबाइल नंबर डालें" required>
      <label>पूरा नाम</label>
      <input type="text" id="name" placeholder="अपना नाम लिखें" required>
      <label>जिला</label>
      <select id="district"><option>Mandsaur</option><option>Neemuch</option><option>Ratlam</option><option>Other</option></select>
      <label>मंडल</label>
      <select id="mandal"><option value="">-- चुनें --</option></select>
      <label>पद (यदि कोई हो)</label>
      <input type="text" id="designation" placeholder="जैसे: मंडल अध्यक्ष, कार्यकर्ता...">
      <label>आने का कारण / कार्यक्रम</label>
      <select id="reason" required>
        <option value="">-- चुनें --</option>
        <option>कार्यालय पर बैठक</option>
        <option>जिला अध्यक्ष से भेंट</option>
        <option>ट्रांसफर / शासकीय कार्य / शिकायत</option>
        <option>कार्यालय पर सामान्य उपस्थिति</option>
        <option>अन्य कोई कार्य</option>
      </select>
      <div id="activeEventDiv" style="display:none; margin-top:10px; padding:10px; background:#e3f2fd; border-radius:8px; border:1px solid #90caf9; color:#0d47a1; font-weight:bold; text-align:center;"></div>
      <label>पता</label>
      <input type="text" id="address" placeholder="गाँव/वार्ड का नाम">
      <div id="camera-area">
        <label>आपकी फोटो</label>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <button type="button" id="snapBtn" style="margin-top:5px; background:#444;">फोटो खींचें</button>
      </div>
      <input type="hidden" id="selfieData">
      <button type="submit" id="submitBtn">सबमिट करें</button>
    </form>
  </div>
<script>
  // Unified Config
  const firebaseConfig = { apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0", authDomain: "mandaleventall.firebaseapp.com", projectId: "mandaleventall", storageBucket: "mandaleventall.firebasestorage.app", messagingSenderId: "900190130114", appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b", measurementId: "G-2BBZZNRS88" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  const MANDALS = ["भेंसोदा","भानपुरा","गरोठ","मेलखेडा","खड़ावदा","शामगढ़","सुवासरा","बसाई","सीतामऊ","क्यामपुर","सीतामऊ ग्रामीण","गुर्जर बरडिया","धुंदधड़का","बुढा","पिपलिया मंडी","मल्हारगढ़","दलोदा","मगरामाता जी","मंदसौर ग्रामीण","मंदसौर उत्तर","मंदसौर दक्षिण","अन्य"];
  const mSel = document.getElementById('mandal');
  MANDALS.forEach(m => { const o = document.createElement('option'); o.value = m; o.textContent = m; mSel.appendChild(o); });

  let activeEventName = null;
  // Listen for active events from 'visitor_events_list'
  db.collection('visitor_events_list').where('active','==',true).onSnapshot(snap=>{
    if(!snap.empty){
      activeEventName = snap.docs[0].data().name;
      const div = document.getElementById('activeEventDiv');
      div.style.display = 'block';
      div.innerText = `वर्तमान कार्यक्रम: ${activeEventName}`;
    } else {
      activeEventName = null;
      document.getElementById('activeEventDiv').style.display = 'none';
    }
  });

  // Camera Logic
  const video=document.getElementById('video'), canvas=document.getElementById('canvas'), snapBtn=document.getElementById('snapBtn');
  navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}}).then(s=>{ video.srcObject=s; document.getElementById('camera-area').style.display='block'; }).catch(e=>console.log(e));
  snapBtn.addEventListener('click',()=>{
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0);
    document.getElementById('selfieData').value = canvas.toDataURL('image/jpeg',0.7);
    video.style.display='none'; canvas.style.display='block';
    snapBtn.innerText='दोबारा खींचें'; snapBtn.onclick=()=>{ video.style.display='block'; canvas.style.display='none'; snapBtn.innerText='फोटो खींचें'; }
  });

  document.getElementById('visitorForm').addEventListener('submit', async(e)=>{
    e.preventDefault();
    const btn=document.getElementById('submitBtn'); btn.disabled=true; btn.innerText='कृपया रुकें...';
    
    const selfieVal = document.getElementById('selfieData').value;
    let selfieUrl = "";
    
    if(selfieVal){
      try {
        const ref = storage.ref(`visitor_selfies/${Date.now()}.jpg`);
        await ref.putString(selfieVal, 'data_url');
        selfieUrl = await ref.getDownloadURL();
      } catch(err) { console.error("Upload error", err); }
    }

    const data = {
      mobile: document.getElementById('mobile').value,
      name: document.getElementById('name').value,
      district: document.getElementById('district').value,
      mandal: document.getElementById('mandal').value,
      designation: document.getElementById('designation').value,
      reason: document.getElementById('reason').value,
      address: document.getElementById('address').value,
      eventName: activeEventName, // attach active event automatically
      selfie: selfieUrl,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      await db.collection('visitors').add(data);
      Swal.fire('सफल!', 'आपकी जानकारी दर्ज हो गई है।', 'success');
      e.target.reset(); document.getElementById('selfieData').value=''; video.style.display='block'; canvas.style.display='none';
      btn.disabled=false; btn.innerText='सबमिट करें';
    } catch(err) {
      Swal.fire('त्रुटि', 'डेटा सेव नहीं हो पाया।', 'error');
      btn.disabled=false; btn.innerText='सबमिट करें';
    }
  });

  // Auto-fill logic
  document.getElementById('mobile').addEventListener('blur', async function(){
    if(this.value.length===10){
      const snap = await db.collection('visitors').where('mobile','==',this.value).limit(1).get();
      if(!snap.empty){
        const d = snap.docs[0].data();
        document.getElementById('name').value = d.name||'';
        document.getElementById('mandal').value = d.mandal||'';
        document.getElementById('designation').value = d.designation||'';
        document.getElementById('address').value = d.address||'';
        Swal.fire({toast:true, position:'top-end', icon:'info', title:'पुराना डेटा मिल गया!', timer:2000, showConfirmButton:false});
      }
    }
  });
</script>
</body>
</html>
